package exam03;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import examjdbc02.JdbcConnectionUtil;
import examjdbc02.MemberVo;

public class MemberDao {
	private JdbcConnectionUtil util;
	
	public MemberDao() {
		util = JdbcConnectionUtil.getInstance();
	}
	
	// C
	public void inserMember(MemberVo vo) {
		Connection conn = null;
		 PreparedStatement pstmt = null;
		 int result = 0;

			try {
				conn = util.getConnection();
				System.out.println("접속 성공");
				
				StringBuffer query = new StringBuffer();
				query.append("insert into member ");
				query.append("(num, memberid, memberpw, nickname, regdate) ");
				query.append("values (MEMBER_SEQ.nextval, ?, ?, ?, sysdate)");
				System.out.println(query.toString());
				
				
				pstmt = conn.prepareStatement(query.toString());
				pstmt.setString(1, vo.getMemberId());
				pstmt.setString(2, vo.getMemberPw());
				pstmt.setString(3, vo.getNickName());
				result = pstmt.executeUpdate(); // 쿼리 전송해서 결과 
				System.out.println(result + "행이 삽입되었습니다.");
				
			} catch(SQLException e) {
				e.printStackTrace();
			} finally {
				util.close(pstmt);
				util.close(conn);
			}
	}
	
	// R
	public MemberVo selectMember(int num) {
		 Connection conn = null;
		 PreparedStatement pstmt = null;
		 ResultSet rs = null;
		 MemberVo result = null;
		 
			try {
				conn = util.getConnection();
				System.out.println("접속 성공");
				pstmt = conn.prepareStatement("select * from member where num = ?");
				pstmt.setInt(1, num);
				rs = pstmt.executeQuery(); // 쿼리 전송해서 결과 
				
				if(rs.next()) {
					result = new MemberVo(
								rs.getInt(1),
								rs.getString(2),
								rs.getString(3),
								rs.getString(4));
					
					result.setRegdate(rs.getDate("regdate"));
				}
				
			} catch(SQLException e) {
				e.printStackTrace();
			} finally {
				util.close(rs);
				util.close(pstmt);
				util.close(conn);
			}
			return result;
	}
	
	public List<MemberVo> selectAll(){
		Connection conn = null;
		PreparedStatement pstmt = null;
		ResultSet rs = null;
		List<MemberVo> result = new ArrayList<>();

		try {
			conn = util.getConnection();
			System.out.println("접속 성공");
			pstmt = conn.prepareStatement("select * from member");
			rs = pstmt.executeQuery(); // 쿼리 전송해서 결과

			while (rs.next()) {
				MemberVo vo = new MemberVo(
						rs.getInt(1), 
						rs.getString(2), 
						rs.getString("memberpw"), 
						rs.getString(4));

				vo.setRegdate(rs.getDate("regdate"));
				
				result.add(vo);
			}

		} catch (SQLException e) {
			e.printStackTrace();
		} finally {
			util.close(rs);
			util.close(pstmt);
			util.close(conn);
		}
		return result;
	}
	
	// U
	public void updateMember(MemberVo vo) {
		db.put(vo.getNum(), vo);
	}
	
	// D
	public void deleteMember(int num) {
		db.remove(num);
	}
	
	public void deleteAll() {
		db.clear();
	}
}
